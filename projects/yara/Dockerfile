FROM fuzzbuilderex:base
LABEL maintainer="KDY <ehddud758@gmail.com>"

# [yara]
# 1. Prepare source codes & project build

COPY . /exp/yara
RUN mkdir -p /exp/yara/source && cd /exp/yara/source && git clone https://github.com/VirusTotal/yara.git && cd yara && git checkout a3784d3855029bd0ad24071e72746cc0c31b8cba && cp ../../fuzzer_main.cc . && cp ../../build_new.sh . && cp /exp/yara/StandaloneFuzzTargetMain.c . && bash ./build_new.sh seed

# 2. FuzzBuilder (seed)
RUN cd /exp/yara/source/yara/ && bash ./build_new.sh seed && cd /exp/yara/source/yara/libyara && /tool/afl-2.52b/afl-clang -emit-llvm -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -I.. -Wall -Wno-deprecated-declarations -std=gnu99 -Iinclude -g -O3   -fvisibility=hidden -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c compiler.c && /tool/afl-2.52b/afl-clang -emit-llvm -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -Wall -Wno-deprecated-declarations -std=gnu99 -Iinclude -g -O3   -fvisibility=hidden -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c rules.c && /tool/fuzzbuilder seed /exp/yara/seed.conf && /tool/afl-2.52b/afl-clang -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -Wall -Wno-deprecated-declarations -std=gnu99 -I./include -g -O3   -fvisibility=hidden -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c compiler.bc.mod.bc -o compiler.o && /tool/afl-2.52b/afl-clang -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -Wall -Wno-deprecated-declarations -std=gnu99 -I./include -g -O3 -fvisibility=hidden -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c rules.bc.mod.bc -o rules.o && ar r .libs/libyara.a rules.o compiler.o && cd .. && rm -f $(find ./* -maxdepth 0 -executable -type f -name "test-*") && make check && mv /tmp/fuzzbuilder.collect . && python /tool/seed_maker.py fuzzbuilder.collect seed_fb && rm -f fuzzbuilder.collect && mkdir -p ../../seed/fuzzbuilder && mv seed_fb ../../seed/fuzzbuilder/org

# 3. OSS-Fuzz (exec, seed)
RUN cd /exp/yara/source/yara && bash ./build_new.sh && mkdir -p ../../bin/fuzz/oss-fuzz && mv *_fuzzer ../../bin/fuzz/oss-fuzz && mkdir -p ../../seed/oss-fuzz/org && unzip -d ../../seed/oss-fuzz/org/dex_fuzzer ./dex_fuzzer_seed_corpus.zip && unzip -d ../../seed/oss-fuzz/org/dotnet_fuzzer ./dotnet_fuzzer_seed_corpus.zip && unzip -d ../../seed/oss-fuzz/org/elf_fuzzer ./elf_fuzzer_seed_corpus.zip && unzip -d ../../seed/oss-fuzz/org/pe_fuzzer ./pe_fuzzer_seed_corpus.zip && unzip -d ../../seed/oss-fuzz/org/rules_fuzzer ./rules_fuzzer_seed_corpus.zip

# 4. FuzzBuilder (exec)
RUN cd /exp/yara/source/yara && cd tests && /tool/afl-2.52b/afl-clang -emit-llvm -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -I.. -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c test-api.c && /tool/fuzzbuilder exec /exp/yara/yr_compiler_add_string.conf && /tool/afl-2.52b/afl-clang -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -I.. -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c test-api.bc.mod.bc -o test-api.o && AFL_USE_ASAN=1 /tool/afl-2.52b/afl-clang -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -m32 -o yr_compiler_add_string_fuzzer test-api.o ./util.o ../libyara/.libs/libyara.a -lm -lm && /tool/fuzzbuilder exec /exp/yara/yr_rules_scan_mem.conf && /tool/afl-2.52b/afl-clang -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c test-api.bc.mod.bc -o test-api.o && AFL_USE_ASAN=1 /tool/afl-2.52b/afl-clang -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -m32 -o yr_rules_scan_mem_fuzzer test-api.o ./util.o ../libyara/.libs/libyara.a -lm -lm && mkdir -p ../../../bin/fuzz/fuzzbuilder && mv *_fuzzer ../../../bin/fuzz/fuzzbuilder

# 5. OSS-Fuzz (cov)
RUN cd /exp/yara/source/yara && bash ./build_new.sh cov && mkdir -p ../../bin/cov/oss-fuzz && mv *_fuzzer ../../bin/cov/oss-fuzz

# 6. FuzzBuilder (cov)
RUN cd /exp/yara/source/yara/tests && /tool/afl-2.52b/afl-clang -emit-llvm -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c test-api.c && /tool/fuzzbuilder exec /exp/yara/yr_compiler_add_string.conf && /tool/afl-2.52b/afl-clang -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c test-api.bc.mod.bc -o test-api.o && /tool/afl-2.52b/afl-clang -fprofile-arcs -ftest-coverage -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE  -m32 -o yr_compiler_add_string_fuzzer test-api.o ./util.o ../libyara/.libs/libyara.a -lm -lm && /tool/fuzzbuilder exec /exp/yara/yr_rules_scan_mem.conf && /tool/afl-2.52b/afl-clang -DPACKAGE_NAME=\"yara\" -DPACKAGE_TARNAME=\"yara\" -DPACKAGE_VERSION=\"3.9.0\" -DPACKAGE_STRING=\"yara\ 3.9.0\" -DPACKAGE_BUGREPORT=\"vmalvarez@virustotal.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"yara\" -DVERSION=\"3.9.0\" -D_FILE_OFFSET_BITS=64 -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_LIBM=1 -DHAVE_LIBM=1 -DHAVE_MEMMEM=1 -DHAVE_TIMEGM=1 -DHAVE_STDBOOL_H=1 -DHAVE_CLOCK_GETTIME=1 -DHAVE_SCAN_PROC_IMPL=1 -I. -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -c test-api.bc.mod.bc -o test-api.o && /tool/afl-2.52b/afl-clang -fprofile-arcs -ftest-coverage -std=gnu99 -Wall -I../libyara/include -g -O3 -m32 -DUSE_LINUX_PROC -pthread -DDOTNET_MODULE -DDEX_MODULE -m32 -o yr_rules_scan_mem_fuzzer test-api.o ./util.o ../libyara/.libs/libyara.a -lm -lm && mkdir -p ../../../bin/cov/fuzzbuilder && mv *_fuzzer ../../../bin/cov/fuzzbuilder

# 7. Seed Optimization

RUN cd /exp/yara && mkdir -p seed/eval/dex_fuzzer && mkdir -p seed/eval/dotnet_fuzzer && mkdir -p seed/eval/elf_fuzzer && mkdir -p seed/eval/pe_fuzzer && mkdir -p seed/eval/rules_fuzzer && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/fuzzbuilder/org/yr_rules_scan_mem -o seed/eval/dex_fuzzer/fuzzbuilder bin/fuzz/oss-fuzz/dex_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/fuzzbuilder/org/yr_rules_scan_mem -o seed/eval/dotnet_fuzzer/fuzzbuilder bin/fuzz/oss-fuzz/dotnet_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/fuzzbuilder/org/yr_rules_scan_mem -o seed/eval/elf_fuzzer/fuzzbuilder bin/fuzz/oss-fuzz/elf_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/fuzzbuilder/org/yr_rules_scan_mem -o seed/eval/pe_fuzzer/fuzzbuilder bin/fuzz/oss-fuzz/pe_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/fuzzbuilder/org/yr_compiler_add_string -o seed/eval/rules_fuzzer/fuzzbuilder bin/fuzz/oss-fuzz/rules_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/oss-fuzz/org/dex_fuzzer -o seed/eval/dex_fuzzer/oss-fuzz bin/fuzz/oss-fuzz/dex_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/oss-fuzz/org/dotnet_fuzzer -o seed/eval/dotnet_fuzzer/oss-fuzz bin/fuzz/oss-fuzz/dotnet_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/oss-fuzz/org/elf_fuzzer -o seed/eval/elf_fuzzer/oss-fuzz bin/fuzz/oss-fuzz/elf_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/oss-fuzz/org/pe_fuzzer -o seed/eval/pe_fuzzer/oss-fuzz bin/fuzz/oss-fuzz/pe_fuzzer @@ && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/oss-fuzz/org/rules_fuzzer -o seed/eval/rules_fuzzer/oss-fuzz bin/fuzz/oss-fuzz/rules_fuzzer @@ && mkdir -p seed/fuzzbuilder/opt && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/fuzzbuilder/org/yr_rules_scan_mem -o seed/fuzzbuilder/opt/yr_rules_scan_mem bin/fuzz/fuzzbuilder/yr_rules_scan_mem_fuzzer && /tool/afl-2.52b/afl-cmin -m 1024 -i seed/fuzzbuilder/org/yr_compiler_add_string -o seed/fuzzbuilder/opt/yr_compiler_add_string bin/fuzz/fuzzbuilder/yr_compiler_add_string_fuzzer
